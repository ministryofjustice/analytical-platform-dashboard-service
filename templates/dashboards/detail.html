{% extends "base/base.html" %}

{% block title %}{{ dashboard.name }} | {{ block.super }}{% endblock title %}

{% block base_div_class %}govuk-grid-column-full{% endblock base_div_class %}

{% block content %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h1 class="govuk-heading-l">{{ dashboard.name }}</h1>
    <div id="dashboard-container"></div>
  </div>
</div>

{% endblock content %}

{% block scripts %}
    <script src="https://unpkg.com/amazon-quicksight-embedding-sdk@2.11.2/dist/quicksight-embedding-js-sdk.min.js"></script>
<script>
(async function() {
    const container = document.getElementById('dashboard-container');

    function setContainerHeight() {
        // Prefer visualViewport (more accurate on mobile), fallback to innerHeight
        const viewportHeight = window.visualViewport?.height ?? window.innerHeight;

        // Calculate 80% of the current viewport height
        const height = Math.floor(viewportHeight * 0.8);

        container.style.height = `${height}px`;
    }

    // Initialize
    setContainerHeight();

    // Listen for both window resize and specific viewport changes (mobile zoom/keyboard)
    window.addEventListener('resize', setContainerHeight);
    window.visualViewport?.addEventListener('resize', setContainerHeight);

    const { createEmbeddingContext } = QuickSightEmbedding;
    const embeddingContext = await createEmbeddingContext();
    const frameOptions = {
        url: "{{ dashboard.embed_url|safe }}",
        container: container,
        height: "100%",
        width: "100%",
    }
    const contentOptions = {
        locale: "en-GB",
        toolbarOptions: {
            export: true,
            undoRedo: true,
            reset: true
        },
        attributionOptions: {
            overlayContent: false,
        },
        onMessage: async (messageEvent) => {
            switch (messageEvent.eventName) {
                case 'ERROR_OCCURRED': {
                    console.log("Error occurred while rendering the experience. Error code:", messageEvent.message.errorCode);
                    break;
                }
                case 'MODAL_OPENED': {
                    window.scrollTo({ top: 0 });
                    break;
                }
            }
        },
    }
    await embeddingContext.embedDashboard(frameOptions, contentOptions);

    // Set accessible name on the SDK-generated iframe
    const iframe = container.querySelector('iframe');
    if (iframe) {
        iframe.title = "{{ dashboard.name }} dashboard";
    }
})();
</script>

{% endblock scripts %}
